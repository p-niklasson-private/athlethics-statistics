<!DOCTYPE HTML>
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <title>Hanviken friidrott - Tävlingsresultat</title>
  <link rel="icon" href="images/favicon.jpg" type="image/jpg" />
  <script type="text/javascript" src="https://www.google.com/jsapi"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script type="text/javascript" src="includes/athletics-stats.js"></script>
  <script type="text/javascript" src="includes/ydn.db-is-core-qry.js"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  
  <link rel="stylesheet" href="http://www.w3schools.com/lib/w3.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
  <link rel="stylesheet" href="includes/athletics-stats.css">
  <script type="text/javascript">
  
  var data
  var html
  //var url = 'http://www.trackandfield.se/resultat/2018/180204lgg.htm'
  //var url = 'http://www.trackandfield.se/resultat/2017/171202.htm'
  var url = 'http://www.huddinge-friidrott.org/tavlingar/17/forsta/171118_19.htm'

  google.charts.load('visualization', '1', { packages : [ 'corechart', 'table', 'controls' ] });
  google.charts.setOnLoadCallback(function() { populateResultData(url); });

  function populateResultData(url) {
     $.getJSON('http://whateverorigin.org/get?url=' + encodeURIComponent(url) + '&callback=?', function(html) {
        // Create the columns in the data table 
        data = new google.visualization.DataTable();
        data.addColumn('string', 'Gren');
        data.addColumn('string', 'Namn');
        data.addColumn('string', 'Född');
        data.addColumn('string', 'Resultat');
        data.addColumn('string', 'Klass');
        data.addColumn('string', 'Klubb');

        // Parse the HTML fom the URL
        var lines = html.contents.split('\n');
        for (var j = 0; j < lines.length; j++) {
            // Getting Class and Events
            if (lines[j].match(/<th align='left' colspan='2'/)) {
                var infostring = remove_html_tags(lines[j])
                var info = infostring.split(/ /);
                var cl = info[0];
                var event = infostring.replace(cl + " ", "");
                if (event.match(/1000m/)) { event = '1.000 meter'; }
                if (event.match(/200m/)) { event = '200 meter'; }
                if (event.match(/400m/)) { event = '400 meter'; }
                if (event.match(/60m/)) { event = '60 meter'; }
                if (event.match(/600m/)) { event = '600 meter'; }
                if (event.match(/800m/)) { event = '800 meter'; }
                if (event.match(/H*jd/)) { event = 'Höjdhopp'; }
                if (event.match(/Kula2.0/)) { event = 'Kula 2,0 kg'; }
                if (event.match(/Kula3.0/)) { event = 'Kula 3,0 kg'; }
                if (event.match(/Kula4.0/)) { event = 'Kula 4,0 kg'; }
                if (event.match(/L*ngdzon/)) { event = 'Längdhopp zon'; }
                if (event.match(/L*ngd/)) { event = 'Längdhopp'; }
                if (event.match(/Stav/)) { event = 'Stavhopp'; }
            }
            if (lines[j].match(/<td width='170'/)) {
                // Relay results, FIXME later
                continue;
            }
            if (lines[j].match(/<td align='right' width='25'/)) {
                var info = lines[j].split(/<\/td>/);
                var name = remove_html_tags(info[1]);
                var year = remove_html_tags(info[2]);
                if (Number(year) > 30) {
                    year = "19" + year;
                }
                else {
                    year = "20" + year;
                }
                var club = remove_html_tags(info[3]);
                var result = remove_html_tags(info[4]);
                
                // All data received, add a row to the Data table 
                data.addRow([event, name, year, result, cl, club]);
            }
        }
        drawDashboard();
     });
  }
  
  function remove_html_tags(html) {
     var tmp = document.createElement("DIV");
     tmp.innerHTML = html;
     return tmp.textContent || tmp.innerText;
  }
  
  function drawDashboard() {
    var dashboard = new google.visualization.Dashboard(document.getElementById('dashboard_div'));

    var eventFilter = filter('event_filter', 0, 'events');
    var nameFilter = filter('name_filter', 1, 'names');
    var yearFilter = filter('year_filter', 2, 'years');
    var classFilter = filter('class_filter', 4, 'classes');    
    var clubFilter = filter('club_filter', 5, 'clubs');

    var resultTable = new google.visualization.ChartWrapper({
          'chartType': 'Table',
          'containerId': 'table_div',
          'options': { allowHtml: true, showRowNumber: false, width: '100%', height: '100%' }
        });

    dashboard.bind(classFilter, [eventFilter, clubFilter, yearFilter, nameFilter]);
    dashboard.bind(eventFilter, [clubFilter, yearFilter, nameFilter]);    
    dashboard.bind(clubFilter, [yearFilter, nameFilter]);
    dashboard.bind(yearFilter, [nameFilter]); 
  
    dashboard.bind([classFilter, eventFilter, clubFilter, yearFilter, nameFilter], resultTable); 
    dashboard.draw(data);
    
    google.visualization.events.addListener(dashboard, 'ready', function() {
        storeFilter(classFilter, 'classes');
        storeFilter(eventFilter, 'events');
        storeFilter(clubFilter, 'clubs');
        storeFilter(nameFilter, 'names');
        storeFilter(nameFilter, 'years');
    });   
  }

  </script>
</head>

<html>
  <body onload="menu('8')">
    <div id="menu"></div>
    <div class="w3-container w3-round-large w3-light-grey w3-margin w3-center">
      <h3 id="page_header">Tävlingsresultat</h3>
    </div>

    <div class="w3-container w3-round-large w3-light-grey w3-margin">
      <p></p>
      <div id="dashboard_div">
        <p></p>
        <table width="90%" align="center">
          <tr valign="top">
            <td>Klass:</td><td><div id="class_filter"></div></td>
            <td>Gren:</td><td><div id="event_filter"></div></td>
          </tr>
          <tr valign="top">
            <td>Klubb:</td><td><div id="club_filter"></div></td>
            <td>Född:</td><td><div id="year_filter"></div></td>
            <td>Namn:</td><td><div id="name_filter"></div></td>
          </tr>
        </table>
        <p></p>
        <div id="table_div" class="w3-center"><p><i class="fa fa-spinner w3-spin" style="font-size:64px"></i></p></div>
        <p></p>
      </div>
    </div>
  </body>
</html>

