<!DOCTYPE HTML>
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <title>Hanviken friidrott - Trender</title>
  <link rel="icon" href="images/favicon.jpg" type="image/jpg" />
  <script type="text/javascript" src="https://www.google.com/jsapi"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script type="text/javascript" src="includes/athletics-stats.js"></script>
  <script type="text/javascript" src="includes/ydn.db-is-core-qry.js"></script>
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  
  <link rel="stylesheet" href="http://www.w3schools.com/lib/w3.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
  <link rel="stylesheet" href="includes/athletics-stats.css">
  <script type="text/javascript">

  var docs = 'all';
  var docList;
  var data;
  var dataList = [];
  var view;
  var resultChart;
  var eventFilter;
  var nameFilter;
  var yearFilter;
  var classFilter;
  var bookmarkUrl = window.location.href;

  google.charts.load('visualization', '1', { packages : [ 'corechart', 'table', 'controls' ] });
  google.charts.setOnLoadCallback(initiateData);
  
  function finished() {
    data.sort([{column: 11},{column: 1}]);
    view = new google.visualization.DataView(data);
    drawDashboard();
  }

  function drawDashboard() {
    var dashboard = new google.visualization.Dashboard(document.getElementById('dashboard_div'));
    
    eventFilter = filterOne('event_filter', 0, 'events');     
    nameFilter =  filter('name_filter', 1, 'names');
    yearFilter =  filter('year_filter', 2, 'years');
    classFilter = filter('class_filter', 8, 'classes');

    var resultTable = new google.visualization.ChartWrapper({
          'chartType': 'Table',
          'containerId': 'table_div',
          'options': { allowHtml: true, showRowNumber: true, width: '95%', height: '100%' }
        });

    resultChart = new google.visualization.ChartWrapper({
          'chartType': 'LineChart',
          'containerId': 'chart_div',
          'options': { 
            legend: 'none',
            pointSize: 10,
            pointShape: 'diamond',
            hAxis: { title: 'Datum', showTextEvery: '1'},
            vAxis: { title: 'Resultat'},
            width: '95%', 
            height: '400',              
          },
        });

    dashboard.bind(eventFilter, [yearFilter, classFilter, nameFilter]);
    dashboard.bind(yearFilter,  [classFilter, nameFilter]);
    dashboard.bind(classFilter, [nameFilter]);
    dashboard.bind([nameFilter, eventFilter,  yearFilter, classFilter], [resultTable, resultChart]);   
    dashboard.draw(view);
  
    google.visualization.events.addListener(eventFilter, 'statechange', setColumns);
    google.visualization.events.addListener(eventFilter, 'ready', setColumns);  
    google.visualization.events.addListener(yearFilter, 'statechange', setColumns);
    google.visualization.events.addListener(yearFilter, 'ready', setColumns);
    google.visualization.events.addListener(classFilter, 'statechange', setColumns);
    google.visualization.events.addListener(classFilter, 'ready', setColumns);
    google.visualization.events.addListener(nameFilter, 'statechange', setColumns);
    google.visualization.events.addListener(nameFilter, 'ready', setColumns);
    google.visualization.events.addListener(resultChart, 'select', selectHandler);
    google.visualization.events.addListener(dashboard, 'ready', storeFilters);
  }

  function storeFilters() {
    storeFilter(eventFilter, 'events');
    storeFilter(classFilter, 'classes');
    storeFilter(yearFilter,  'years');
    storeFilter(nameFilter,  'names');
  }

  function setColumns() {
    var event = eventFilter.getState().selectedValues[0];
    var names = nameFilter.getState().selectedValues;
    var years = yearFilter.getState().selectedValues;
    var classes = classFilter.getState().selectedValues;

    var tooltip_column;    
    // Set tooltip column based on the names values
    if (names && names.length == 1) {
        tooltip_column = 10; // Competition
    }
    else {
        tooltip_column = 1; // Name
    }

    // Set result column based on the event value
    var result_column;
    if (event.match(/kamp/)) {
        result_column = 6; // Points
    }
    else if (event.match(/meter|Stafett|Häck|mile/)) {
        result_column = 4; // Time
    }
    else {
        result_column = 5; // Length
    }
    
    // Set title based on the set values
    var title;
    if (names && names.length != 0) {
        title = event + " - " + names;
    }
    else if (classes && classes.length != 0)  {
        title = event + " - " + classes;
    }
    else if (years && years.length != 0)  {
        title = event + " - Födda " + years;
    }
    else {
        title = event;
    }
    
    resultChart.setOption('title', title);
    resultChart.setView({'columns': [11, result_column,{sourceColumn: tooltip_column, role: "tooltip"}]});
    resultChart.draw();
  }
  
  function selectHandler() {
    var selectedItem = resultChart.getChart().getSelection()[0];
    var chartData = resultChart.getDataTable();
    var selectedName = chartData.getValue(selectedItem.row, selectedItem.column);
    console.log(selectedName);
    nameFilter.setState({selectedValues: [selectedName]});
    nameFilter.draw();
  }
  
  </script>
</head>

<html>
  <body onload="menu('3','31')";>
    <div id="menu"></div>
    <p></p>
    <div class="w3-container w3-round-large w3-light-grey w3-margin w3-center">
      <h3 id="page_header">Resultat och trender per tävlande och gren</h3>
    </div>
    <div class="w3-container w3-round-large w3-light-grey w3-margin w3-center">
      <div id="dashboard_div">
        <p></p>
        <table width="95%" align="center">
          <tr valign="top">
            <td>Gren:</td><td><div id="event_filter"></div></td>
            <td>Född:</td><td><div id="year_filter"></div></td>
            <td>Klass:</td><td><div id="class_filter"></div></td>
            <td>Namn:</td><td><div id="name_filter"></div></td>
            <td align="right"><a href="#" id="permaLink" title="Permanent link to this page with filters"><i class="fa fa-bookmark"></i></a></td>
          </tr>
        </table>
        <p></p>
        <div id="chart_div" class="w3-center"></div>
        <p></p>
        <div id="table_div" class="w3-center"><p><i class="fa fa-spinner w3-spin" style="font-size:64px"></i></p></div>
        <p></p>
      </div>
    </div>
  </body>
</html>
