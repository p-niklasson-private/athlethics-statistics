<!DOCTYPE HTML>
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <title>Hanviken friidrott - Trender</title>
  <link rel="icon" href="http://friidrott.niklassons.net/favicon.jpg" type="image/jpg" />
  <script type="text/javascript" src="https://www.google.com/jsapi"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script type="text/javascript" src="includes/athletics-stats.js"></script>

  <link rel="stylesheet" href="http://www.w3schools.com/lib/w3.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
  <script type="text/javascript">

  google.load('visualization', '1', { packages : [ 'corechart', 'table' ] });
  google.charts.setOnLoadCallback(initiateData);

  var docList;
  var data;
  var dataList = [];
  var view;
  var filterList = [];
  var table;
  var chart;
  var bookmarkUrl;
  
  function finished() {
    data.sort([{column: 11},{column: 1}]);
    filterData();
  }

  function filterData() {
    var event = '';
    var name = '';
    var year = '';
    var klass = '';

    view = new google.visualization.DataView(data);

    filterList = [];
    bookmarkUrl = window.location.href;
    
    // Filter on events in column '0'
    var eventNo = eventForm.eventList.selectedIndex;
    if (eventNo) {
        event = eventForm.eventList.options[eventNo].text;
        filterList.push({column:0, value:event});
        bookmarkUrl = updateUrl(bookmarkUrl,'event',event);
    }

    // Filter on names in column 1
    var nameNo = nameForm.nameList.selectedIndex;
    if (nameNo) {
       name = nameForm.nameList.options[nameNo].text;
       filterList.push({column:1, value:name});
       bookmarkUrl = updateUrl(bookmarkUrl,'name',name);
    }
    
    // Filter on birth year in column 2
    var yearNo = yearForm.yearList.selectedIndex;
    if (yearNo) {
        year = yearForm.yearList.options[yearNo].text;
       filterList.push({column:2, value:year});
       bookmarkUrl = updateUrl(bookmarkUrl,'year',year);
    }
    
    // Filter on class in column 8
    var classNo = classForm.classList.selectedIndex;
    if (classNo) {
        klass = classForm.classList.options[classNo].text;
        filterList.push({column:8, value:klass});
        bookmarkUrl = updateUrl(bookmarkUrl,'class',klass);
    }

    // Apply the filter
    if(filterList.length > 0){
      view.setRows(view.getFilteredRows(filterList));
    }

    populateSelections();

    var options = {
      title: event + ' ' + name,
      legend: 'none',
      pointSize: 10,
      pointShape: 'diamond',
      hAxis: { title: 'Datum', showTextEvery: '1'},
      vAxis: { title: 'Resultat'},
      width: '100%', 
      height: '400',
    };
    if (event) {
        table = new google.visualization.Table(document.getElementById('table_div'));    
        table.draw(view, {showRowNumber: true, width: '100%', height: '100%'});
        
        if (! name) {
            tooltip_column = 1;
        }
        else {
            tooltip_column = 10;
        }
        
        if (event.match(/Mångkamp/)){
            result_column = 6;
        }
        else if (event.match(/meter|Stafett|Häck/)){
            result_column = 4;
        }
        else {
            result_column = 5;
        }
        
        view.setColumns([11,result_column,
                         {calc: "stringify", sourceColumn: result_column, role: "annotation", type: "string"},
                         {sourceColumn: tooltip_column, role: "tooltip"}
                        ]);

        document.getElementById('bookmarkUrl').innerHTML = '<a href="' + bookmarkUrl + '">' + bookmarkUrl + '</a>';
        chart = new google.visualization.LineChart(document.getElementById('chart_div'));
        chart.draw(view, options);
        
        if (! name){
            google.visualization.events.addListener(chart, 'select', selectHandler);
        }
    }
    else {
        view.setRows([]);
        
        table = new google.visualization.Table(document.getElementById('table_div'));    
        table.draw(view, {showRowNumber: true, width: '100%', height: '100%'});

        view.setColumns([11,5]);
        chart = new google.visualization.LineChart(document.getElementById('chart_div'));
        chart.draw(view, options);
    }
  }
  
  function selectHandler() {
    // Get the 'name' value of the selected chart point
    var selectedItem = chart.getSelection()[0];
    var selectedName = view.getValue(selectedItem.row, 3);
    console.log(selectedName);

    // Set the name as selected in the drop down box
    var nameSelectionList=document.getElementById('nameList');
    nameSelectionList.innerHTML = '';
    nameSelectionList.add(new Option("- Alla namn -", 'all'));
    nameSelectionList.add(new Option(selectedName, selectedName));
    nameSelectionList.options.selectedIndex = 1;
    
    /// Run it through the filterData()
    filterData();
  }
  
  function populateSelections() {
    populateEventSelections();
    populateNameSelections();
    populateYearSelections();
    populateClassSelections();
  }
  
  </script>
</head>

<html>
  <body onload="menu('3','31')";>
  <div id="menu"></div>
  <p></p>
  <div class="w3-container w3-round-large w3-light-grey w3-margin w3-center">
    <h3 id="page_header">Resultat och trender per tävlande och gren</h3>
  </div>
  <div class="w3-container w3-round-large w3-light-grey w3-margin w3-center">
  <p></p> 
  <table width="90%" align="center">
    <tr>
      <td><b>Gren:</b></td>
      <td>
        <form name="eventForm">
          <select id="eventList" name="eventList" onChange="filterData()">
            <option>- Alla grenar -
          </select>
        </form>
      </td>
      <td><b>Född:</b></td>
      <td>
        <form name="yearForm">
          <select id="yearList" name="yearList" onChange="filterData()">
            <option>- Alla födelseår -
          </select>
        </form>
      </td>
      <td><b>Klass:</b></td>
      <td>
        <form name="classForm">
          <select id="classList" name="classList" onChange="filterData()">
            <option>- Alla klasser -
          </select>
        </form>
      </td>
      <td><b>Namn:</b></td>
      <td>
        <form name="nameForm">
          <select id="nameList" name="nameList" onChange="filterData()">
            <option>- Alla namn -
          </select>
        </form>
      </td>
      <td><button class="w3-right w3-btn w3-white w3-border w3-border-green w3-round-xlarge" onClick="clearFilter('clear')">Rensa alla filter</button></td>
    </tr>
  </table>
  <p></p>
  <div id="bookmarkUrl" class="w3-tiny w3-right-align"></div>
  <div id="chart_div" class="w3-center"></div>
  <p></p>
  <div id="table_div" class="w3-center"><p><i class="fa fa-spinner w3-spin" style="font-size:64px"></i></p></div>
  <p></p>
  </div>
  </body>
</html>
