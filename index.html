<!DOCTYPE HTML>
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <title>Google Spreadsheets</title>

  <script type="text/javascript" src="https://www.google.com/jsapi"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script type="text/javascript">

  google.load('visualization', '1', { packages : [ 'corechart', 'table' ] });
  google.charts.setOnLoadCallback(initiate_data);

  var docList = ["1kgJxJ8skKZ5bGXEiIht3FTnTVRjAFPvlitZEFEK-Eto", // Utomhus 2016
                 "1TB8Bwit9Qxdvl1QnaRyMX5fhKaZaQtrltjfubab4tN8", // Inomhus 2015-2016
                 "13qz03TyakxsCM4Bsr_HDjePukusZ_TV7d_aKwGO2l9M", // Utomhus 2015
                ];
  var data;
  var dataList = [];
  var view;
  var filterList = [];
  var table;
  
  function initiate_data() {
    var queryString = encodeURIComponent('SELECT *');
    for (i = 0; i < docList.length; i++) { 
        var queryUrl = "https://docs.google.com/spreadsheets/d/" + docList[i] + "/gviz/tq?headers=1&tq=" + queryString;
        var query = new google.visualization.Query(queryUrl);
        query.send(handleQueryResponse);
        console.log(docList[i]);
    }
  }

  function handleQueryResponse(response) {
    if (response.isError()) {
      alert('Error in query: ' + response.getMessage() + ' ' + response.getDetailedMessage());
      return;
    }
    dataList.push(response.getDataTable());
    finished();
  }

  function finished() {
    if (dataList.length != docList.length) {
        //do nothing if data tables are not fully ready
        return;
    }
    var json = JSON.parse(dataList[0].toJSON());
    for (i = 1; i < dataList.length; i++) { 
        var json2 = JSON.parse(dataList[i].toJSON());
        var mergedRows = json.rows.concat(json2.rows);
        json.rows = mergedRows;
    }
    data = new google.visualization.DataTable(json);
    console.log(json);
    filter_data();
  }

  function filter_data() {
    view = new google.visualization.DataView(data);
    table = new google.visualization.Table(document.getElementById('table_div'));
    filterList = [];
    
    // Filter on events in column '0'
    var eventNo = eventForm.eventList.selectedIndex;
    if (eventNo) {
        filterList.push({column:0, value:eventForm.eventList.options[eventNo].text});
    }
    
    // Filter on names in column 1
    var nameNo = nameForm.nameList.selectedIndex;
    if (nameNo) {
       filterList.push({column:1, value:nameForm.nameList.options[nameNo].text});
    }
    // Filter on birth year in column 2
    var yearNo = yearForm.yearList.selectedIndex;
    if (yearNo) {
       filterList.push({column:2, value:yearForm.yearList.options[yearNo].text});
    }
    
    // Filter on class in column 7
    var classNo = classForm.classList.selectedIndex;
    if (classNo) {
        filterList.push({column:7, value:classForm.classList.options[classNo].text});
    }
    
    // Filter on competition in column 8
    var competitionNo = competitionForm.competitionList.selectedIndex;
    if (competitionNo) {
        filterList.push({column:8, value:competitionForm.competitionList.options[competitionNo].text});
    }    

    // Filter on season in column 10
    var seasonNo = seasonForm.seasonList.selectedIndex;
    if (seasonNo) {
        filterList.push({column:10, value:seasonForm.seasonList.options[seasonNo].text});
    }    

    // Apply the filter, and draw the table
    if(filterList.length > 0){
      view.setRows(view.getFilteredRows(filterList));
    }
    table.draw(view, {showRowNumber: false, width: '1800', height: '100%'});
    populate_selections();
  }
  
  function populate_selections() {
    // Populating Names
    // Get the index number for the selected value
    var eventNo = eventForm.eventList.selectedIndex;

    // Empty the selection list
    var eventSelectionList=document.getElementById('eventList');
    eventSelectionList.innerHTML = '';
    
    // Populate the selection list with values from the filtered data
    var events = view.getDistinctValues(0);
    eventSelectionList.add(new Option("- Alla grenar -", 'all'));
    for(var i = 0; i < events.length; i++) {
        eventSelectionList.add(new Option(events[i], events[i]));
    }
    
    // Set the selected value. Remember that a selected value filters out everything except 2 values
    if (eventSelectionList.length == 2){
        if (eventNo) eventSelectionList.options.selectedIndex = 1;
        else eventSelectionList.options.selectedIndex = 0;
    }
    
    // Populating Names
    var nameNo = nameForm.nameList.selectedIndex;
    var nameSelectionList=document.getElementById('nameList');
    nameSelectionList.innerHTML = '';
    var names = view.getDistinctValues(1);
    nameSelectionList.add(new Option("- Alla namn -", 'all'));
    for(var i = 0; i < names.length; i++) {
        nameSelectionList.add(new Option(names[i], names[i]));
    }
    if (nameSelectionList.length == 2){
        if (nameNo) nameSelectionList.options.selectedIndex = 1;
        else nameSelectionList.options.selectedIndex = 0;
    }

    // Populating Birth years
    var yearNo = yearForm.yearList.selectedIndex;
    var yearSelectionList=document.getElementById('yearList');
    yearSelectionList.innerHTML = '';
    var years = view.getDistinctValues(2);
    yearSelectionList.add(new Option("- Alla födelseår -", 'all'));
    for(var i = 0; i < years.length; i++) {
        yearSelectionList.add(new Option(years[i], years[i]));
    }
    if (yearSelectionList.length == 2){
        if (yearNo) yearSelectionList.options.selectedIndex = 1;
        else yearSelectionList.options.selectedIndex = 0;
    }

    // Populating Classes
    var classNo = classForm.classList.selectedIndex;
    var classSelectionList=document.getElementById('classList');
    classSelectionList.innerHTML = '';
    var classes = view.getDistinctValues(7);
    classSelectionList.add(new Option("- Alla klasser -", 'all'));
    for(var i = 0; i < classes.length; i++) {
        classSelectionList.add(new Option(classes[i], classes[i]));
    }
    if (classSelectionList.length == 2){
        if (classNo) classSelectionList.options.selectedIndex = 1;
        else classSelectionList.options.selectedIndex = 0;
    }
    
    // Populating Competitions
    var competitionNo = competitionForm.competitionList.selectedIndex;
    var competitionSelectionList=document.getElementById('competitionList');
    competitionSelectionList.innerHTML = '';
    var competitions = view.getDistinctValues(8);
    competitionSelectionList.add(new Option("- Alla tävlingar -", 'all'));
    for(var i = 0; i < competitions.length; i++) {
        competitionSelectionList.add(new Option(competitions[i], competitions[i]));
    }
    if (competitionSelectionList.length == 2){
        if (competitionNo) competitionSelectionList.options.selectedIndex = 1;
        else competitionSelectionList.options.selectedIndex = 0;
    }
    
    // Populating Seasons
    var seasonNo = seasonForm.seasonList.selectedIndex;
    var seasonSelectionList=document.getElementById('seasonList');
    seasonSelectionList.innerHTML = '';
    var seasons = view.getDistinctValues(10);
    seasonSelectionList.add(new Option("- Alla säsonger -", 'all'));
    for(var i = 0; i < seasons.length; i++) {
        seasonSelectionList.add(new Option(seasons[i], seasons[i]));
    }
    if (seasonSelectionList.length == 2){
        if (seasonNo) seasonSelectionList.options.selectedIndex = 1;
        else seasonSelectionList.options.selectedIndex = 0;
    }
  }
  </script>
</head>

<html>
<body>

<h1>Statistik för Hanvikens SK Friidrott</h1>
<table width="800">
  <tr>
    <td><b>Säsong:</b></td>
    <td>
      <form name="seasonForm">
        <select id="seasonList" name="seasonList" onChange="filter_data()">
          <option>- Alla säsonger -
        </select>
      </form>
    </td>
    <td><b>Tävling:</b></td>
    <td>
      <form name="competitionForm">
        <select id="competitionList" name="competitionList" onChange="filter_data()">
          <option>- Alla tävlingar -
        </select>
      </form>
    </td>
    <td><b>Gren:</b></td>
    <td>
      <form name="eventForm">
        <select id="eventList" name="eventList" onChange="filter_data()">
            <option>- Alla grenar -
        </select>
      </form>
    </td>
  </tr>
  <tr>
    <td><b>Namn:</b></td>
    <td>
      <form name="nameForm">
        <select id="nameList" name="nameList" onChange="filter_data()">
          <option>- Alla namn -
        </select>
      </form>
    </td>
    <td><b>Född:</b></td>
    <td>
      <form name="yearForm">
        <select id="yearList" name="yearList" onChange="filter_data()">
          <option>- Alla födelseår -
        </select>
      </form>
    </td>
    <td><b>Klass:</b></td>
    <td>
      <form name="classForm">
        <select id="classList" name="classList" onChange="filter_data()">
          <option>- Alla klasser -
        </select>
      </form>
    </td>
</tr>
</table>    
<p></p>
<div id="table_div"></div>

</body>
</html>
