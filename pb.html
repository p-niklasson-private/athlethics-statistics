<!DOCTYPE HTML>
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <title>Hanviken friidrott - Personbästa</title>
  <link rel="icon" href="http://friidrott.niklassons.net/favicon.jpg" type="image/jpg" />
  <script type="text/javascript" src="https://www.google.com/jsapi"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <link rel="stylesheet" href="http://www.w3schools.com/lib/w3.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
  <script type="text/javascript">

  google.load('visualization', '1', { packages : [ 'corechart', 'table' ] });
  google.charts.setOnLoadCallback(initiateData);

  var docList = [
                 "1WbKxsWGzVrk48C5YrZ_KS-Aw9To4RZA42c0mJy4sALk", // Inomhus 2016-2017
                 "1kgJxJ8skKZ5bGXEiIht3FTnTVRjAFPvlitZEFEK-Eto", // Utomhus 2016
                 "1TB8Bwit9Qxdvl1QnaRyMX5fhKaZaQtrltjfubab4tN8", // Inomhus 2015-2016
                 "13qz03TyakxsCM4Bsr_HDjePukusZ_TV7d_aKwGO2l9M", // Utomhus 2015
                 "1lUsY9HwXjM3mxrQ_YVfhSw1JvJJdaU8Jmj53xUn9U_M", // Inomhus 2014-2015
                ];
  var data;
  var dataList = [];
  var view;
  var filterList = [];
  var table;
  var chart;
  
  function initiateData() {
    var queryString = encodeURIComponent('SELECT *');
    for (i = 0; i < docList.length; i++) { 
        var queryUrl = "https://docs.google.com/spreadsheets/d/" + docList[i] + "/gviz/tq?headers=1&tq=" + queryString;
        var query = new google.visualization.Query(queryUrl);
        query.send(handleQueryResponse);
        console.log(docList[i]);
    }
  }

  function handleQueryResponse(response) {
    if (response.isError()) {
      alert('Error in query: ' + response.getMessage() + ' ' + response.getDetailedMessage());
      return;
    }
    dataList.push(response.getDataTable());
    finished();
  }

  function finished() {
    if (dataList.length != docList.length) {
        //do nothing if data tables are not fully ready
        return;
    }
    var json = JSON.parse(dataList[0].toJSON());
    for (i = 1; i < dataList.length; i++) { 
        var json2 = JSON.parse(dataList[i].toJSON());
        var mergedRows = json.rows.concat(json2.rows);
        json.rows = mergedRows;
    }
    data = new google.visualization.DataTable(json);
    data.sort([{column: 0},{column: 3, type: 'number'},{column: 4, desc: true},{column: 5, desc: true}]);
    console.log(json);

    filterData();
  }

  function filterData() {
    var name = '';

    view = new google.visualization.DataView(data);

    filterList = [];
    
    // Filter on names in column 1
    var nameNo = nameForm.nameList.selectedIndex;
    if (nameNo) {
       name = nameForm.nameList.options[nameNo].text;
       filterList.push({column:1, value:name});
    }

    if (name) {
        var pb_rows = [];
        var rows = view.getFilteredRows(filterList);
        var current_event = 'start';
        var first_result = true;
        for(var i = 0; i < rows.length; i++) {
            var event = view.getValue(rows[i],0);
            if (current_event != event) {
                // First time we see this event. The first row will contain the PB!
                pb_rows.push(rows[i]);
                current_event = event;
            }
        }

        // Filter out all the PB rows that we collected
        view.setRows(pb_rows);
        populateSelections();   
        table = new google.visualization.Table(document.getElementById('table_div'));    
        table.draw(view, {showRowNumber: true, width: '1800', height: '100%'});
    }
    else {
        populateSelections();
        view.setRows([]);
        table = new google.visualization.Table(document.getElementById('table_div'));
        table.draw(view, {showRowNumber: true, width: '1800', height: '100%'});
    }
  }

  function populateSelections() {

    // Populating Names
    var nameNo = nameForm.nameList.selectedIndex;
    var nameSelectionList=document.getElementById('nameList');
    nameSelectionList.innerHTML = '';
    var names = view.getDistinctValues(1);
    nameSelectionList.add(new Option("- Alla namn -", 'all'));
    for(var i = 0; i < names.length; i++) {
        nameSelectionList.add(new Option(names[i], names[i]));
    }
    if (nameSelectionList.length == 2){
        if (nameNo) nameSelectionList.options.selectedIndex = 1;
        else nameSelectionList.options.selectedIndex = 0;
    }
  }
  
  </script>
</head>

<html>
  <body>
      <ul class="w3-navbar w3-round-large w3-light-grey w3-medium w3-margin">
        <li><a href="index.html"><i class="fa fa-table"></i> Resultat</a></li>
        <li><a class="w3-green" href="pb.html"><i class="fa fa-table"></i> Personbästa</a></li>
        <li class="w3-dropdown-hover">
          <a href="#"><i class="fa fa-bar-chart"></i> Statistik <i class="fa fa-caret-down"></i></a>
          <div class="w3-dropdown-content w3-white w3-card-4">
            <a href="stats.html?graph=1"><i class="fa fa-pie-chart"></i> Antal starter per födelseår</a>
            <a href="trends.html"><i class="fa fa-line-chart"></i> Resultat, trender per tävlande och gren</a>
            <a href="#">Link 2</a>
            <a href="#">Link 3</a>
          </div>
        </li>    
        <li class="w3-dropdown-hover">
          <a href="#"><i class="fa fa-map"></i> Kartor <i class="fa fa-caret-down"></i></a>
          <div class="w3-dropdown-content w3-white w3-card-4">
            <a href="map.html?map=1"><i class="fa fa-map-marker"></i> Inomhustävlingar 2016-2017</a>
            <a href="map.html?map=2"><i class="fa fa-map-marker"></i> Utomhustävlingar 2016</a>
          </div>
        </li>
        <li class="w3-dropdown-hover">
          <a href="#"><i class="fa fa-link"></i> Länkar <i class="fa fa-caret-down"></i></a>
          <div class="w3-dropdown-content w3-white w3-card-4">
            <a href="https://hanvikenssk.myclub.se/friidrott" target="_blank">Hanviken SK friidrott</a>
            <a href="http://friidrott.se" target="_blank">Friidrott.se</a>
          </div>
        </li>
      </ul>
<div class="w3-container w3-round-large w3-light-grey w3-margin w3-center">
  <h3 id="page_header">Personbästalista per tävlande</h3>
  <p>
    <b>Notera:</b> Sorteringen för löpgrenar är inte OK än. Sorteras som strängar, inte som nummer...
  </p>
</div>
<div class="w3-container w3-round-large w3-light-grey w3-margin">
<p></p>
<table width="1000" align="center">
  <tr>
    <td><b>Namn:</b></td>
    <td>
      <form name="nameForm">
        <select id="nameList" name="nameList" onChange="filterData()">
          <option>- Alla namn -
        </select>
      </form>
    </td>
</tr>
</table>
<p></p>
<div id="table_div" class="w3-center"></div>
<p></p>
</div>
</body>
</html>
