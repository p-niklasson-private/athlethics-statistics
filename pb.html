<!DOCTYPE HTML>
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <title>Hanviken friidrott - Personbästa</title>
  <link rel="icon" href="images/favicon.jpg" type="image/jpg" />
  <script type="text/javascript" src="https://www.google.com/jsapi"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script type="text/javascript" src="includes/athletics-stats.js"></script>

  <link rel="stylesheet" href="http://www.w3schools.com/lib/w3.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
  <script type="text/javascript">
  
  var docs;
  var badges = findGetParameter('badges');
  if (badges == 'true') {
    docs = 'badges';
  }
  else {
    docs = 'all';
  }
  var docList;
  var data;
  var dataList = [];
  var view;
  var filterList = [];
  var table;
  var chart;
  var bookmarkUrl;

  google.load('visualization', '1', { packages : [ 'corechart', 'table' ] });
  google.charts.setOnLoadCallback(initiateData);
  
  function finished() {
    data.sort([{column: 1},{column: 0},{column: 4},{column: 5, desc: true},{column: 6, desc: true}]);
    var badgesFormatter = new google.visualization.ColorFormat();
    badgesFormatter.addRange('Guld', 'Gulda', 'black', 'gold');
    badgesFormatter.addRange('Silver', 'Silvera', 'black', 'silver');
    badgesFormatter.addRange('Brons', 'Bronsa', 'black', 'peru');
    badgesFormatter.format(data, 1);
    var recordFormatter  = new google.visualization.ColorFormat();
    recordFormatter.addRange('Klubbrekord','Klubbrekorda','black','gold');
    recordFormatter.format(data, 12);
    filterData();
  }

  function filterData() {
    view = new google.visualization.DataView(data);
    var name;
    var event;
    var year;
    var klass;
    filterList = [];

    bookmarkUrl = window.location.href.split("?")[0];
    
    // Filter on events in column '0'
    var eventNo = eventForm.eventList.selectedIndex;
    if (eventNo) {
        event = eventForm.eventList.options[eventNo].text;
        filterList.push({column:0, value:event});
        bookmarkUrl = updateUrl(bookmarkUrl,'event',event);
    }

    // Filter on names in column 1
    var nameNo = nameForm.nameList.selectedIndex;
    if (nameNo) {
       name = nameForm.nameList.options[nameNo].text;
       bookmarkUrl = updateUrl(bookmarkUrl,'name',name); 
       filterList.push({column:1, value:name});
    }
    
    // Filter on birth year in column 2
    var yearNo = yearForm.yearList.selectedIndex;
    if (yearNo) {
        year = yearForm.yearList.options[yearNo].text;
        filterList.push({column:2, value:year});
        bookmarkUrl = updateUrl(bookmarkUrl,'year',year);
    }
    
    // Filter on klass in column 8
    var classNo = classForm.classList.selectedIndex;
    if (classNo) {
        klass = classForm.classList.options[classNo].text;
        filterList.push({column:8, value:klass});
        bookmarkUrl = updateUrl(bookmarkUrl,'class',klass);
    }

    if (event || name || year || klass) {
        var pb_rows = [];
        var rows = view.getFilteredRows(filterList);
        var current_event = 'start';
        var current_name = 'start';
        for(var i = 0; i < rows.length; i++) {
            var event = view.getValue(rows[i],0);
            var name = view.getValue(rows[i],1);
            var season = view.getValue(rows[i],12);
            if (~season.indexOf("Klubbrekord")) {
                // Keep all Klubbrekord
                pb_rows.push(rows[i]);
                continue;
            }
            if (current_event != event || current_name != name)  {
                // First time we see this event or name. The first row will contain the PB!
                pb_rows.push(rows[i]);
                current_event = event;
                current_name = name;
            }
        }
        view.setRows(pb_rows);
        populateSelections();
    }
    else {
        populateSelections();   
        view.setRows([]);
    }

    document.getElementById('bookmarkUrl').innerHTML = '<a href="' + bookmarkUrl + '">' + bookmarkUrl + '</a>';
    table = new google.visualization.Table(document.getElementById('table_div'));
    table.draw(view, {showRowNumber: true, allowHtml: true, width: '100%', height: '100%'});
  }

  function populateSelections() {
    populateEventSelections();
    populateNameSelections();
    populateYearSelections();
    populateClassSelections();
  }
  
  </script>
</head>

<html>
  <body onload="menu('2')">
    <div id="menu"></div>
    <div class="w3-container w3-round-large w3-light-grey w3-margin w3-center">
      <h3 id="page_header">Personbästa per åldersgrupp, tävlande och gren</h3>
    </div>
    <div class="w3-container w3-round-large w3-light-grey w3-margin">
      <p></p>
      <table width="90%" align="center">
        <tr>
        <td><b>Gren:</b></td>
        <td>
            <form name="eventForm">
              <select id="eventList" name="eventList" onChange="filterData()">
                <option>- Alla grenar -
              </select>
            </form>
          </td>
        <td><b>Född:</b></td>
        <td>
            <form name="yearForm">
              <select id="yearList" name="yearList" onChange="filterData()">
                <option>- Alla födelseår -
              </select>
            </form>
        </td>
        <td><b>Klass:</b></td>
        <td>
          <form name="classForm">
            <select id="classList" name="classList" onChange="filterData()">
              <option>- Alla klasser -
            </select>
          </form>
        </td>
        <td><b>Namn:</b></td>
        <td>
            <form name="nameForm">
              <select id="nameList" name="nameList" onChange="filterData()">
                <option>- Alla namn -
              </select>
            </form>
        </td>
        <td><button class="w3-right w3-btn w3-white w3-border w3-border-green w3-round-xlarge" onClick="clearFilter('clear')">Rensa alla filter</button></td>
        </tr>
      </table>
      <p></p>
      <div id="bookmarkUrl" class="w3-tiny w3-right-align"></div>
      <div id="table_div" class="w3-center"><p><i class="fa fa-spinner w3-spin" style="font-size:64px"></i></p></div>
      <p></p>
    </div>
  </body>
</html>
